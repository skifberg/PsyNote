#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ PsyNote —Å–µ—Ä–≤–µ—Ä–∞

echo "üéØ –ó–∞–ø—É—Å–∫ PsyNote —Å–µ—Ä–≤–µ—Ä–∞..."
echo "üìÇ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [[ ! $(pwd) == *"PsyNote"* ]]; then
    echo "‚ùå –ù–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ PsyNote. –ü–µ—Ä–µ—Ö–æ–¥–∏–º..."
    cd /Users/oleg/PsyNote
fi

echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º venv
if [ -d "venv" ]; then
    echo "‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ"
    source venv/bin/activate
    echo "üêç Python: $(python --version)"
    echo "üì¶ PIP: $(pip --version)"
else
    echo "‚ùå –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!"
    echo "–°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ: python -m venv venv"
    exit 1
fi

echo "üìÅ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ backend/app..."
cd backend/app

echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ —Å–µ—Ä–≤–µ—Ä..."
# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–ø—É—â–µ–Ω –ª–∏ —É–∂–µ —Å–µ—Ä–≤–µ—Ä
if lsof -Pi :8000 -sTCP:LISTEN -t >/dev/null ; then
    echo "‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä —É–∂–µ –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 8000"
    echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å..."
    pkill -f "uvicorn main:app"
    sleep 2
fi

echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä..."
echo "üì° –°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ: http://localhost:8000"
echo "üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API: http://localhost:8000/docs"
echo ""
echo "–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C"
echo "----------------------------------------"

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä
uvicorn main:app --reload --port 8000 --host 0.0.0.0